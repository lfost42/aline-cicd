# AWS LB Controller - Create ClusterRole, ClusterRoleBinding & ServiceAccount
# kubectl apply -f https://raw.githubusercontent.com/kubernetes-sigs/aws-alb-ingress-controller/master/docs/examples/rbac-role.yaml
# aws iam create-policy \
#     --policy-name AWSLoadBalancerControllerIAMPolicy \
#     --policy-document file://iam_policy_latest.json
# arn:aws:iam::052911266688:policy/AWSLoadBalancerControllerIAMPolicy

# eksctl create iamserviceaccount \
#   --cluster=lf-aline \
#   --namespace=kube-system \
#   --name=aws-load-balancer-controller \
#   --attach-policy-arn=arn:aws:iam::052911266688:policy/AWSLoadBalancerControllerIAMPolicy \
#   --override-existing-serviceaccounts \
#   --region us-west-1 \
#   --approve

eksctl delete iamserviceaccount aws-load-balancer-controller --namespace kube-system --cluster lf-aline
# allow incoming traffic on TCP 9443 from k8s control plan for webhook access

kubectl apply -k "github.com/aws/eks-charts/stable/aws-load-balancer-controller//crds?ref=master"
helm install aws-load-balancer-controller eks/aws-load-balancer-controller -n kube-system --set clusterName=lf-aline-cluster --set serviceAccount.create=false --set serviceAccount.name=aws-load-balancer-controller
# helm uninstall aws-load-balancer-controller -n kube-system

# verify domains are mapping:
curl -i -H "Host: admin.alinefinancial.com" http://a2de8ecf5edac43a284d9636c22c945e-1261427252.us-west-1.elb.amazonaws.com
curl -i -H "Host: alinefinancial.com" http://a5f23b5a274af4219aa5e02c7f850d90-1766176637.us-west-1.elb.amazonaws.com
curl -i -H "Host: api.alinefinancial.com" http://a5f23b5a274af4219aa5e02c7f850d90-1766176637.us-west-1.elb.amazonaws.com
curl -i -H "Host: member.alinefinancial.com" http://a40c7f8b237c44e94b8fac42f2525063-1040091005.us-west-1.elb.amazonaws.com

# since we don't own the domains, route them locally to /etc/hosts - https://www.nslookup.io/
# 54.183.75.4 admin.alinefinancial.com
# 54.183.9.66 admin.alinefinancial.com
# 54.183.43.136 alinefinancial.com
# 54.183.85.125 alinefinancial.com
# 54.183.43.136 api.alinefinancial.com
# 54.183.85.125 api.alinefinancial.com
# 54.183.50.184 member.alinefinancial.com
# 54.183.71.183 member.alinefinancial.com