# AWS LB Controller - Create ClusterRole, ClusterRoleBinding & ServiceAccount
# kubectl apply -f https://raw.githubusercontent.com/kubernetes-sigs/aws-alb-ingress-controller/master/docs/examples/rbac-role.yaml
# aws iam create-policy \
#     --policy-name AWSLoadBalancerControllerIAMPolicy \
#     --policy-document file://iam_policy_latest.json

# eksctl create iamserviceaccount \
#   --cluster=lf-aline \
#   --namespace=kube-system \
#   --name=aws-load-balancer-controller \
#   --attach-policy-arn=arn:aws:iam::052911266688:policy/AWSLoadBalancerControllerIAMPolicy \
#   --override-existing-serviceaccounts \
#   --region us-west-1 \
#   --approve

# allow incoming traffic on TCP 443 on k8s control plane for webhook access

# kubectl apply -k "github.com/aws/eks-charts/stable/aws-load-balancer-controller//crds?ref=master"
# helm install aws-load-balancer-controller eks/aws-load-balancer-controller -n kube-system --set clusterName=lf-aline --set serviceAccount.create=false --set serviceAccount.name=aws-load-balancer-controller

helm install aws-load-balancer-controller eks/aws-load-balancer-controller \
    --set clusterName=lf-aline \
    --set serviceAccount.create=false \
    --set region=us-west-1 \
    --set vpcId=vpc-01fac557e86febc0e \
    --set serviceAccount.name=aws-load-balancer-controller \
    -n kube-system

kubectl apply -f manifest/frontend/

# helm uninstall aws-load-balancer-controller -n kube-system

node_security_group_additional_rules = {
    ingress_allow_access_from_control_plane = {
      type                          = "ingress"
      protocol                      = "tcp"
      from_port                     = 9443
      to_port                       = 9443
      source_cluster_security_group = true
      description                   = "Allow access from control plane to webhook port of AWS load balancer controller"
    }
  }

# verify domains are mapping:
curl -i -H "Host: admin.alinefinancial.com" http://a2de8ecf5edac43a284d9636c22c945e-1261427252.us-west-1.elb.amazonaws.com
curl -i -H "Host: alinefinancial.com" http://a5f23b5a274af4219aa5e02c7f850d90-1766176637.us-west-1.elb.amazonaws.com
curl -i -H "Host: api.alinefinancial.com" http://a5f23b5a274af4219aa5e02c7f850d90-1766176637.us-west-1.elb.amazonaws.com
curl -i -H "Host: member.alinefinancial.com" http://a40c7f8b237c44e94b8fac42f2525063-1040091005.us-west-1.elb.amazonaws.com


https://www.nslookup.io/domains/adb44aae7f3004a87b8b323f39e557e1-944149971.us-west-1.elb.amazonaws.com/dns-records/
https://www.nslookup.io/domains/ad86ff82a4faf4c8d8777c2bbc4b91ae-398505821.us-west-1.elb.amazonaws.com/dns-records/
https://www.nslookup.io/aa06dbed398be47e288853aea800f7bb-1073899846.us-west-1.elb.amazonaws.com/dns-records/
52.9.61.138 admin.alinefinancial.com
52.9.61.138 admin.alinefinancial.com
13.56.94.208 alinefinancial.com
52.9.183.187 alinefinancial.com
13.56.94.208 api.alinefinancial.com
52.9.183.187 api.alinefinancial.com
54.151.20.82 member.alinefinancial.com
50.18.198.47 member.alinefinancial.com